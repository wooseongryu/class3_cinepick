<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.itwillbs.cinepick.mapper.BookingMapper">
	<select id="selectValidCity" resultType="Theater">
		SELECT
			CONCAT(c.city_name, "(", count(s.sche_idx) , ")") AS city_name
			, c.city_idx
		FROM
			schedule s JOIN theater t 
			ON s.sche_theater_idx = t.theater_idx
			JOIN city c 
			ON t.city_idx = c.city_idx 
		WHERE
			s.sche_movie_code = #{movie_code}
		GROUP BY 
			c.city_name
			, c.city_idx
	</select>
	
	<select id="selectValidTheater" resultType="Theater">
		SELECT
			t.theater_name
			, t.theater_idx
		FROM
			schedule s JOIN theater t 
			ON s.sche_theater_idx = t.theater_idx
			JOIN city c 
			ON t.city_idx = c.city_idx 
		WHERE
			s.sche_movie_code = #{movie_code}
			AND c.city_idx = #{city_idx}
		GROUP BY
			t.theater_name
			, t.theater_idx
	</select>
	
	<select id="selectValidDate" resultType="ScheduleVO">
		SELECT DISTINCT sche_date 
		FROM schedule
		WHERE 
			sche_movie_code = #{movie_code}
			AND sche_theater_idx = #{theater_idx}
		ORDER BY sche_date
		LIMIT 15
	</select>
	
	<select id="selectValidTime" resultType="ScheduleVO">
		SELECT 
			s.sche_idx 
			, s.sche_start_time
			, sc.screen_name 
		FROM schedule s JOIN screen sc
			ON s.sche_screen_idx = sc.screen_idx
		WHERE s.sche_movie_code = #{movie_code}
				AND s.sche_theater_idx = #{theater_idx}
				AND s.sche_date = #{date}
		ORDER BY 
			s.sche_screen_idx
			, s.sche_start_time
	</select>
	
	<select id="selectMovie" resultType="Movie">
		SELECT 
			movie_nameK
			, movie_poster
		FROM movie
		WHERE movie_code = ${movie_code}
	</select>
</mapper>